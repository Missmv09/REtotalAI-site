<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Deal Analyzer ‚Ä¢ REtotalAI</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/scripts/auth.js"></script>
  <script src="/scripts/FairHousingScanner.js"></script>
  <script>
    // Property Notes Fair Housing Compliance Check
    document.addEventListener('DOMContentLoaded', function() {
      const notesField = document.getElementById('propertyNotes');
      const warningEl = document.getElementById('notesComplianceWarning');
      const warningText = document.getElementById('notesWarningText');

      if (notesField && typeof FairHousingScanner !== 'undefined') {
        notesField.addEventListener('blur', function() {
          const text = this.value.trim();
          if (!text) {
            warningEl.style.display = 'none';
            return;
          }

          const result = FairHousingScanner.quickScan(text);

          if (!result.isCompliant) {
            const highRisk = result.hasHighRisk ? ' (includes high-risk issues)' : '';
            warningText.textContent = `${result.count} potential violation(s) detected${highRisk}. Consider reviewing before sharing this content.`;
            warningEl.style.display = 'block';
          } else {
            warningEl.style.display = 'none';
          }
        });
      }
    });
  </script>
  <script>
    const IS_PRODUCTION = window.location.hostname === 'retotalai.com';
  </script>
  <style>
    body { font-family:sans-serif; max-width:1100px; margin:40px auto; line-height:1.5; }
    h2 { margin:0 0 4px }
    h3 { margin:24px 0 8px }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px; }
    .card { border:1px solid #eee; border-radius:12px; padding:14px; background:#fff; }
    input { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; }
    label { font-size:13px; color:#444; display:block; margin-bottom:6px }
    button { padding:10px 16px; border:none; background:#111; color:#fff; border-radius:8px; cursor:pointer; font-size:14px; }
    button.secondary { background:#555 }
    button.danger { background:#b00020 }
    button.ghost { background:#f5f5f5; color:#111; border:1px solid #ddd }
    button[disabled] { opacity:0.6; cursor:not-allowed; }
    .result { display:none; border-radius:12px; padding:16px; border:1px solid #eee; background:#fafafa; }
    .kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-top:12px }
    .kpi { background:#fff; border:1px solid #eee; border-radius:10px; padding:12px }
    .kpi h4 { margin:0 0 6px; font-size:13px; color:#555 }
    .kpi div { font-size:18px; font-weight:700 }
    .verdict { margin-top:16px; padding:12px 14px; border-radius:10px; font-weight:600 }
    .good { background:#ecfbf1; color:#0f7b3a; border:1px solid #b8efd1 }
    .maybe { background:#fff8e6; color:#8a5b00; border:1px solid #ffe2a9 }
    .bad { background:#ffecec; color:#a30000; border:1px solid #ffc2c2 }
    .tips { margin-top:14px; padding:12px 14px; border-radius:10px; background:#fff; border:1px solid #eee }
    .tips h4 { margin:0 0 8px; font-size:14px; color:#333 }
    .tips ul { margin:0; padding-left:18px }
    table { width:100%; border-collapse:collapse; margin-top:16px; background:#fff; border-radius:10px; overflow:hidden }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }
    th { background:#fafafa; }
    .right { text-align:right }
    .muted { color:#666; font-size:12px }
    .win { background:#ecfbf1 }

    .plan-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .plan-badge {
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px; background:#f5f5f5;
      font-size:11px; text-transform:uppercase; letter-spacing:0.06em; color:#444;
    }
    .plan-dot {
      width:7px; height:7px; border-radius:50%;
      background:#999;
    }
    .plan-dot.pro { background:#0f7b3a; }
    .plan-dot.free { background:#d97706; }

    /* Logged-out "save your deals" row on Deal Analyzer */
    .recent-login-message-row td {
      padding: 14px 18px;
      border-top: 1px solid #f0f0f0;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
    }

    .recent-login-message {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      font-size: 0.95rem;
      color: #333;
    }

    .recent-login-lock {
      font-size: 1.2rem;
      margin-right: 4px;
    }

    .recent-login-text {
      display: flex;
      flex-direction: column;
      flex: 1;
      text-align: left;
    }

    .recent-login-text strong {
      font-weight: 600;
    }

    .recent-login-subtext {
      font-size: 0.88rem;
      color: #777;
      margin-top: 2px;
    }

    /* Brand-aligned login button (black with gold hover) */
    .recent-login-button {
      background: #000;
      color: #fff;
      border-radius: 999px;
      padding: 8px 18px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      white-space: nowrap;
      transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease;
    }

    .recent-login-button:hover {
      background: #f5b931; /* REtotalAi gold accent */
      color: #000;
      transform: translateY(-1px);
    }

    /* Tooltip for benefits of saving deals */
    .recent-login-tooltip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1px solid #ddd;
      font-size: 0.75rem;
      cursor: default;
      color: #555;
      flex-shrink: 0;
    }

    .recent-login-tooltip-text {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: 125%;
      right: 0;
      background: #111;
      color: #fff;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      width: 240px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
      transition: opacity 0.15s ease;
      z-index: 10;
    }

    .recent-login-tooltip:hover .recent-login-tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    .recent-login-tooltip-text::after {
      content: '';
      position: absolute;
      top: 100%;
      right: 10px;
      border-width: 6px;
      border-style: solid;
      border-color: #111 transparent transparent transparent;
    }

    /* Mobile tweaks */
    @media (max-width: 600px) {
      .recent-login-message {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .recent-login-button {
        width: 100%;
        text-align: center;
      }
    }

    /* ROW: Logged-out message */
    .ra-loggedout-row td {
      padding: 14px 18px;
      background: #fafafa;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
    }

    /* FLEX container */
    .ra-loggedout-flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    /* LOCK ICON */
    .ra-lock-icon {
      font-size: 1.25rem;
      margin-right: 6px;
    }

    /* TEXT BLOCK */
    .ra-textblock {
      flex: 1;
      text-align: left;
    }

    .ra-textblock strong {
      font-weight: 600;
    }

    .ra-subtext {
      margin-top: 3px;
      font-size: 0.88rem;
      color: #777;
    }

    /* LOGIN BUTTON */
    .ra-login-btn {
      background: #000;
      color: #fff;
      border: none;
      border-radius: 30px;
      padding: 8px 18px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ra-login-btn:hover {
      background: #f5b931;
      color: #000;
    }

    /* Tooltip bubble */
    .ra-tooltip {
      position: relative;
      display: inline-flex;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1px solid #ccc;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      cursor: default;
    }

    .ra-tooltip-content {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s ease;
      position: absolute;
      width: 240px;
      background: #111;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      bottom: 130%;
      right: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 10;
    }

    .ra-tooltip:hover .ra-tooltip-content {
      visibility: visible;
      opacity: 1;
    }

    .ra-tooltip-content::after {
      content: "";
      position: absolute;
      top: 100%;
      right: 10px;
      border-width: 6px;
      border-style: solid;
      border-color: #111 transparent transparent transparent;
    }

    /* ===== RESPONSIVE STYLES ===== */

    /* Tablet - 768px */
    @media (max-width: 768px) {
      body {
        margin: 20px 16px;
        max-width: 100%;
      }

      .grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .kpis {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      table {
        font-size: 13px;
      }

      th, td {
        padding: 8px 10px;
      }

      .plan-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .upgrade-modal {
        max-width: 90%;
        padding: 16px;
      }

      button {
        min-height: 44px;
        padding: 12px 16px;
      }
    }

    /* Phone - 480px */
    @media (max-width: 480px) {
      body {
        margin: 16px 12px;
      }

      h2 {
        font-size: 1.4rem;
      }

      h3 {
        font-size: 1.1rem;
        margin: 20px 0 8px;
      }

      .grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .card {
        padding: 12px;
      }

      input {
        padding: 12px;
        font-size: 16px; /* Prevents iOS zoom */
        min-height: 44px;
      }

      label {
        font-size: 12px;
        margin-bottom: 4px;
      }

      .kpis {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .kpi {
        padding: 10px;
      }

      .kpi h4 {
        font-size: 11px;
      }

      .kpi div {
        font-size: 16px;
      }

      .verdict {
        padding: 10px 12px;
        font-size: 14px;
      }

      .tips {
        padding: 10px 12px;
      }

      .tips ul {
        padding-left: 16px;
        font-size: 13px;
      }

      table {
        font-size: 12px;
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      th, td {
        padding: 8px;
        white-space: nowrap;
      }

      button {
        width: 100%;
        min-height: 48px;
        font-size: 15px;
        margin-bottom: 8px;
      }

      .chip-row {
        justify-content: flex-start;
      }

      .chip {
        font-size: 10px;
        padding: 3px 6px;
      }

      .upgrade-actions {
        flex-direction: column;
        gap: 8px;
      }

      .upgrade-actions button {
        width: 100%;
      }
    }

    /* Small Phone - 375px */
    @media (max-width: 375px) {
      body {
        margin: 12px 8px;
      }

      h2 {
        font-size: 1.25rem;
      }

      .kpis {
        grid-template-columns: 1fr;
      }

      .kpi {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
      }

      .kpi h4 {
        margin: 0;
      }

      .kpi div {
        margin: 0;
      }

      input {
        padding: 14px 12px;
      }

      button {
        min-height: 50px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="plan-row">
    <div>
      <h2>Deal Analyzer</h2>
      <p class="muted">Mortgage, DSCR, CoC, Cap Rate, Cash Flow + expert verdict, scenario comparison, and history.</p>
    </div>
    <div class="plan-badge" id="planBadge">
      <span class="plan-dot free" id="planDot"></span>
      <span id="planBadgeText">Free plan</span>
    </div>
  </div>

  <!-- Purchase / Loan -->
  <div class="card">
    <h3>Purchase & Financing</h3>
    <div class="grid">
      <div><label>Purchase Price ($)</label><input id="price" type="number" placeholder="400000"></div>
      <div><label>Down Payment (%)</label><input id="downPct" type="number" placeholder="20" value="20"></div>
      <div><label>Interest Rate (%, annual)</label><input id="rate" type="number" step="0.01" placeholder="6.75" value="6.75"></div>
      <div><label>Term (years)</label><input id="term" type="number" placeholder="30" value="30"></div>
      <div><label>Closing Costs (%)</label><input id="closingPct" type="number" step="0.1" placeholder="3" value="3"></div>
      <!-- Renovation budget field -->
      <div>
        <label>Renovation Budget ($)</label>
        <input id="renoBudget" type="number" placeholder="e.g. 25000">
        <p id="renoNote" class="muted" style="margin-top:4px; display:none;">
          Imported from Renovation Estimator as the all-in (high) estimate including contingency. Adjust if you have updated bids or a different scope.
        </p>
      </div>
    </div>
  </div>

  <!-- Income -->
  <div class="card">
    <h3>Income</h3>
    <div class="grid">
      <div><label>Monthly Rent ($)</label><input id="rent" type="number" placeholder="2800"></div>
      <div><label>Other Monthly Income ($)</label><input id="otherIncome" type="number" placeholder="0" value="0"></div>
      <div><label>Vacancy (%)</label><input id="vacancyPct" type="number" step="0.5" placeholder="5" value="5"></div>
    </div>
  </div>

  <!-- Operating Expenses -->
  <div class="card">
    <h3>Operating Expenses (Monthly)</h3>
    <div class="grid">
      <div><label>Taxes ($)</label><input id="taxes" type="number" placeholder="300"></div>
      <div><label>Insurance ($)</label><input id="insurance" type="number" placeholder="120"></div>
      <div><label>HOA ($)</label><input id="hoa" type="number" placeholder="0"></div>
      <div><label>Utilities ($)</label><input id="utilities" type="number" placeholder="0"></div>
      <div><label>Mgmt (% of Rent)</label><input id="mgmtPct" type="number" placeholder="8" value="8"></div>
      <div><label>Maintenance (% of Rent)</label><input id="maintPct" type="number" placeholder="5" value="5"></div>
      <div><label>CapEx (% of Rent)</label><input id="capexPct" type="number" placeholder="5" value="5"></div>
    </div>
  </div>

  <!-- Property Notes -->
  <div class="card">
    <h3>Property Notes <span style="font-size:12px;color:#666;font-weight:normal">(Optional)</span></h3>
    <div>
      <label style="font-size:13px;color:#444;display:block;margin-bottom:6px">Notes about the property, listing details, or marketing copy</label>
      <textarea id="propertyNotes" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:14px;min-height:80px;resize:vertical" placeholder="Add notes about the property, paste listing descriptions, or any details you want to track..."></textarea>
      <div id="notesComplianceWarning" style="display:none;margin-top:8px;padding:8px 12px;background:#FEF3C7;border:1px solid #FCD34D;border-radius:6px;font-size:13px;color:#92400E">
        <strong>Fair Housing Alert:</strong> <span id="notesWarningText"></span>
      </div>
    </div>
  </div>

  <div class="grid" style="margin:12px 0">
    <button id="analyze-btn" onclick="analyze()">Analyze Deal</button>
    <button id="saveBtn" class="secondary" onclick="saveDeal()" disabled title="Analyze first">Save Deal</button>
    <button class="ghost" onclick="snapshotBaseline()">Save as Baseline for Comparison</button>
  </div>

  <!-- Free trial limit message (hidden by default) -->
  <div
    id="deal-limit-banner"
    style="
      display: none;
      margin: 18px 0;
      padding: 14px 18px;
      border-radius: 10px;
      border: 1px solid #facc15;
      background: #fffbeb;
      font-size: 14px;
      color: #78350f;
    "
  >
    <div style="margin-bottom: 10px;">
      <strong>You've used your 3 free Deal Analyzer analyses.</strong>
      <span style="margin-left: 4px;">Upgrade for unlimited deal runs, saved scenarios, and more.</span>
    </div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <a
        href="https://buy.stripe.com/00wdR894NfEPcgH5LC9Ve03"
        target="_blank"
        rel="noopener noreferrer"
        style="
          padding: 8px 16px;
          border-radius: 999px;
          background: #111827;
          color: #fff;
          font-size: 13px;
          font-weight: 500;
          text-decoration: none;
        "
      >
        Upgrade to Growth ‚Äì $149/mo
      </a>
      <a
        href="https://buy.stripe.com/28E5kCcgZ50b2G7ei89Ve05"
        target="_blank"
        rel="noopener noreferrer"
        style="
          padding: 8px 16px;
          border-radius: 999px;
          border: 1px solid #d1d5db;
          background: #fff;
          color: #374151;
          font-size: 13px;
          text-decoration: none;
        "
      >
        Professional ‚Äì $299/mo
      </a>
    </div>
  </div>

  <div id="results" class="result">
    <h3>Results</h3>
    <div class="kpis">
      <div class="kpi"><h4>Cap Rate</h4><div id="capRate">‚Äî</div></div>
      <div class="kpi"><h4>DSCR</h4><div id="dscr">‚Äî</div></div>
      <div class="kpi"><h4>Cash-on-Cash</h4><div id="coc">‚Äî</div></div>
      <div class="kpi"><h4>Cash Flow / mo</h4><div id="cashFlow">‚Äî</div></div>
      <div class="kpi"><h4>Debt Service / mo</h4><div id="pmt">‚Äî</div></div>
    </div>
    <div id="verdict" class="verdict">‚Äî</div>

    <div class="tips" id="tweakBox" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h4>What to tweak</h4>
        <span class="locked-label" id="tweakLockLabel" style="display:none;">
          <span class="lock-icon">üîí</span> Pro Tip Stream
        </span>
      </div>
      <ul id="tweakList"></ul>
      <p class="muted">Targets: DSCR ‚â• 1.25, CoC ‚â• 8%, cash flow ‚â• $100/mo.</p>
    </div>

    <!-- Compare Scenarios -->
    <div class="card" style="margin-top:16px">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0 0 4px">Compare Scenarios</h3>
        <span class="locked-label" id="scenarioLockLabel">
          <span class="lock-icon">üîí</span> Premium Feature
        </span>
      </div>
      <p class="muted" id="baselineNote">Baseline: <em>not captured yet</em>. Click ‚ÄúSave as Baseline for Comparison‚Äù.</p>

      <div class="grid">
        <div class="card">
          <h4 style="margin-top:0">Scenario B (quick tweaks)</h4>
          <div class="grid">
            <div><label>Price Cut ($)</label><input id="b_priceCut" type="number" placeholder="e.g. 15000"></div>
            <div><label>Rent Increase ($/mo)</label><input id="b_rentUp" type="number" placeholder="e.g. 150"></div>
            <div><label>Rate Buydown (pts %)</label><input id="b_rateDown" type="number" step="0.125" placeholder="e.g. 0.5"></div>
            <div><label>Extra Down (% of Price)</label><input id="b_downUpPct" type="number" step="0.5" placeholder="e.g. 5"></div>
            <div><label>Expense Trim ($/mo)</label><input id="b_expTrim" type="number" placeholder="e.g. 50"></div>
          </div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
            <button class="ghost" onclick="recalcScenarioB()">Preview Scenario B</button>
            <button class="secondary" onclick="applyScenarioB()">Apply Scenario B to inputs</button>
            <button class="secondary" onclick="saveScenarioB()">Save Scenario B as Deal</button>
          </div>
        </div>

        <div class="card">
          <h4 style="margin-top:0">Side-by-side KPIs</h4>
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th class="right">Baseline</th>
                <th class="right">Scenario B</th>
              </tr>
            </thead>
            <tbody id="cmpBody">
              <tr><td colspan="3" class="muted">Enter tweaks and click ‚ÄúPreview Scenario B‚Äù.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:8px">Notes: NOI excludes debt service; Cap Rate = NOI/Price. DSCR = NOI / Annual Debt Service. CoC uses cash invested (down + closing + rehab).</p>
  </div>

  <section style="margin-top:28px">
    <h3>Your Recent Analyses</h3>
    <table class="recent-deals-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Price</th>
          <th>Rent</th>
          <th>DSCR</th>
          <th>CoC %</th>
          <th>Cap %</th>
          <th>CF/mo</th>
        </tr>
      </thead>

      <tbody id="deal-history-body">
        <tr id="deal-history-loading">
          <td colspan="7">Loading...</td>
        </tr>
      </tbody>
    </table>
  </section>


  <script>
    let lastCalc = null;
    let baseline = null;
    let currentPlan = "free";

    (async () => {
      let user = null;
      try {
        const { data: userData } = await sb.auth.getUser();
        user = userData?.user || null;
      } catch (e) {
        console.error("Auth check failed", e);
      }

      // If not logged in, keep everything usable but show a friendly message
      if (!user) {
        currentPlan = "free";
        applyPlanGating();
        await loadRecentAnalyses();
        return;
      }

      // Logged-in path: load plan + recent deals
      try {
        currentPlan = (user?.user_metadata?.plan) || "free"; // "free" | "starter" | "pro"
      } catch (e) {
        console.error("Failed to load user plan", e);
        currentPlan = "free";
      }

      applyPlanGating();
      await loadRecentAnalyses();
    })();

    // ---------- helpers ----------
    function n(v){ return Number(v || 0); }
    function pct(v){ return Number(v || 0)/100; }
    function fmt(num){ return Number(num).toLocaleString(undefined,{maximumFractionDigits:2}); }
    function roundTo(val, step){ return Math.round(val/step)*step; }

    function pmt(rate, nper, pv) {
      if (rate === 0) return -(pv / nper);
      const r = rate;
      return -(pv * r * Math.pow(1+r, nper)) / (Math.pow(1+r, nper) - 1);
    }

    function applyPlanGating(){
      // Hide plan badge since there's no paid tier
      const planBadge = document.getElementById("planBadge");
      if (planBadge) planBadge.style.display = "none";

      // Hide lock labels since all features are available
      const scenarioLock = document.getElementById("scenarioLockLabel");
      const tweakLock = document.getElementById("tweakLockLabel");
      if (scenarioLock) scenarioLock.style.display = "none";
      if (tweakLock) tweakLock.style.display = "none";
    }

    // Auto-fill Renovation Budget from Renovation Estimator (if present)
    (function () {
      try {
        const stored = localStorage.getItem("retotalai_reno_estimate");
        if (!stored) return;

        const renoInput = document.getElementById("renoBudget");
        const renoNote = document.getElementById("renoNote");
        const val = Number(stored);

        if (renoInput && !isNaN(val) && val > 0) {
          renoInput.value = val;
          if (renoNote) {
            renoNote.style.display = "block";
          }
        }

        // Clear it so it doesn't keep applying forever
        localStorage.removeItem("retotalai_reno_estimate");
      } catch (e) {
        console.warn("Unable to read reno estimate from localStorage", e);
      }
    })();

    // ---------- I/O ----------
    function readInputs(){
      return {
        price: n(document.getElementById("price").value),
        downPct: pct(document.getElementById("downPct").value),
        rateAnnual: pct(document.getElementById("rate").value),
        termYears: n(document.getElementById("term").value),
        closingPct: pct(document.getElementById("closingPct").value),
        rehabBudget: n(document.getElementById("renoBudget").value),

        rent: n(document.getElementById("rent").value),
        otherIncome: n(document.getElementById("otherIncome").value),
        vacancyPct: pct(document.getElementById("vacancyPct").value),

        taxes: n(document.getElementById("taxes").value),
        insurance: n(document.getElementById("insurance").value),
        hoa: n(document.getElementById("hoa").value),
        utilities: n(document.getElementById("utilities").value),
        mgmtPct: pct(document.getElementById("mgmtPct").value),
        maintPct: pct(document.getElementById("maintPct").value),
        capexPct: pct(document.getElementById("capexPct").value)
      };
    }

    function writeInputs(obj){
      if ("price" in obj) document.getElementById("price").value = obj.price;
      if ("downPct" in obj) document.getElementById("downPct").value = (obj.downPct*100).toFixed(2);
      if ("rateAnnual" in obj) document.getElementById("rate").value = (obj.rateAnnual*100).toFixed(3);
      if ("termYears" in obj) document.getElementById("term").value = obj.termYears;
      if ("closingPct" in obj) document.getElementById("closingPct").value = (obj.closingPct*100).toFixed(2);
      if ("rehabBudget" in obj) document.getElementById("renoBudget").value = obj.rehabBudget ?? 0;

      if ("rent" in obj) document.getElementById("rent").value = obj.rent;
      if ("otherIncome" in obj) document.getElementById("otherIncome").value = obj.otherIncome ?? 0;
      if ("vacancyPct" in obj) document.getElementById("vacancyPct").value = (obj.vacancyPct*100).toFixed(2);

      if ("taxes" in obj) document.getElementById("taxes").value = obj.taxes ?? 0;
      if ("insurance" in obj) document.getElementById("insurance").value = obj.insurance ?? 0;
      if ("hoa" in obj) document.getElementById("hoa").value = obj.hoa ?? 0;
      if ("utilities" in obj) document.getElementById("utilities").value = obj.utilities ?? 0;
      if ("mgmtPct" in obj) document.getElementById("mgmtPct").value = (obj.mgmtPct*100).toFixed(2);
      if ("maintPct" in obj) document.getElementById("maintPct").value = (obj.maintPct*100).toFixed(2);
      if ("capexPct" in obj) document.getElementById("capexPct").value = (obj.capexPct*100).toFixed(2);
    }

    // ---------- Core calc ----------
    function calcKPIs(ctx){
      const rate = ctx.rateAnnual/12;
      const downPayment = ctx.price * ctx.downPct;
      const closingCosts = ctx.price * ctx.closingPct;
      const rehabBudget = ctx.rehabBudget || 0;
      const loanAmount = Math.max(ctx.price - downPayment, 0);
      const months = ctx.termYears * 12;
      const monthlyDebt = -pmt(rate, months, loanAmount);
      const annualDebt = monthlyDebt * 12;

      const grossRentMo = ctx.rent + ctx.otherIncome;
      const vacancyLossMo = grossRentMo * ctx.vacancyPct;
      const mgmtMo = ctx.rent * ctx.mgmtPct;
      const maintMo = ctx.rent * ctx.maintPct;
      const capexMo = ctx.rent * ctx.capexPct;

      const opexMo = ctx.taxes + ctx.insurance + ctx.hoa + ctx.utilities + mgmtMo + maintMo + capexMo;
      const noiAnnual = (grossRentMo - vacancyLossMo - opexMo) * 12;

      const capRate = (noiAnnual / ctx.price) * 100;
      const dscr = annualDebt > 0 ? (noiAnnual / annualDebt) : Infinity;
      const monthlyCashFlow = (grossRentMo - vacancyLossMo - opexMo - monthlyDebt);
      const annualCF = monthlyCashFlow * 12;
      const cashInvested = downPayment + closingCosts + rehabBudget;
      const coc = cashInvested > 0 ? (annualCF / cashInvested) * 100 : 0;

      return {
        capRate, dscr, coc, monthlyCashFlow, monthlyDebt, annualDebt,
        noiAnnual, cashInvested, downPayment, closingCosts, rehabBudget,
        opexMo, grossRentMo, vacancyLossMo
      };
    }

    function analyze() {
      const ctx = readInputs();
      if (!ctx.price || !ctx.rent) {
        alert("Please enter at least Price and Rent.");
        return;
      }

      const k = calcKPIs(ctx);

      document.getElementById("capRate").textContent = `${fmt(k.capRate)}%`;
      document.getElementById("dscr").textContent = k.dscr===Infinity? "‚àû" : fmt(k.dscr);
      document.getElementById("coc").textContent = `${fmt(k.coc)}%`;
      document.getElementById("cashFlow").textContent = `$${fmt(k.monthlyCashFlow)}`;
      document.getElementById("pmt").textContent = `$${fmt(k.monthlyDebt)}`;
      document.getElementById("results").style.display = "block";

      const verdictEl = document.getElementById("verdict");
      const v = buildVerdict({
        dscr:k.dscr,
        coc:k.coc,
        capRate:k.capRate,
        monthlyCashFlow:k.monthlyCashFlow
      });
      verdictEl.className = `verdict ${v.className}`;
      verdictEl.textContent = v.message;

      buildTweaks({ ...ctx, ...k });

      lastCalc = {
        price: ctx.price, rent: ctx.rent, expenses: k.opexMo,
        down_payment_pct: ctx.downPct*100, interest_rate: ctx.rateAnnual*100, term_years: ctx.termYears,
        closing_cost_pct: ctx.closingPct*100, other_income: ctx.otherIncome, vacancy_pct: ctx.vacancyPct*100,
        taxes_monthly: ctx.taxes, insurance_monthly: ctx.insurance, hoa_monthly: ctx.hoa, utilities_monthly: ctx.utilities,
        mgmt_pct: ctx.mgmtPct*100, maint_pct: ctx.maintPct*100, capex_pct: ctx.capexPct*100,
        rehab_budget: ctx.rehabBudget,
        roi: 0, cap_rate: Number(k.capRate.toFixed(2)), cash_flow: Number(k.monthlyCashFlow.toFixed(2)),
        dscr: Number((k.dscr===Infinity? 9999 : k.dscr).toFixed(3)), coc: Number(k.coc.toFixed(2))
      };

      const saveBtn = document.getElementById("saveBtn");
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.title = "";
      }
    }

    function buildVerdict({ dscr, coc, capRate, monthlyCashFlow }) {
      let score = 0;
      if (dscr >= 1.25) score += 2; else if (dscr >= 1.1) score += 1;
      if (coc >= 8) score += 2; else if (coc >= 5) score += 1;
      if (monthlyCashFlow >= 100) score += 1;
      if (capRate >= 7) score += 1;

      if (score >= 5) return { className:"good", message:"BUY: DSCR and CoC look strong with positive cash flow. This pencils for most lenders and conservative investors." };
      if (score >= 3) return { className:"maybe", message:"MAYBE: Close. Improve price/down/rate or raise rent / trim expenses to reach DSCR ‚â• 1.25 and CoC ‚â• 8%." };
      return { className:"bad", message:"PASS: DSCR/CoC weak or cash flow thin/negative. Renegotiate terms or move on." };
    }

    // ---------- What to tweak ----------
    function buildTweaks(ctx) {
      const T_DSCR=1.25, T_COC=8, T_CF=100;
      const effRentFactor = Math.max(0.01, 1 - ctx.vacancyPct - ctx.mgmtPct - ctx.maintPct - ctx.capexPct);
      const list = [];
      const dscrGap = Math.max(0, T_DSCR - (ctx.dscr===Infinity? 10 : ctx.dscr));
      const cocGap  = Math.max(0, T_COC - ctx.coc);
      const cfGap   = Math.max(0, T_CF - ctx.monthlyCashFlow);

      if (dscrGap > 0 && isFinite(ctx.annualDebt) && ctx.annualDebt > 0) {
        const reqNOI = T_DSCR * ctx.annualDebt;
        const deltaNOIannual = Math.max(0, reqNOI - ctx.noiAnnual);
        const deltaRentMo = (deltaNOIannual / 12) / effRentFactor;
        if (deltaRentMo > 1) list.push(`Increase rent by ~ $${fmt(roundTo(deltaRentMo,25))}/mo to reach DSCR 1.25.`);
      }

      const cut = findPriceCutForTargetDSCR(ctx, T_DSCR);
      if (dscrGap > 0 && cut > 0) list.push(`Negotiate price down ~ $${fmt(roundTo(cut,1000))} to reach DSCR 1.25.`);

      const buy = findRateBuydownForTargetDSCR(ctx, T_DSCR);
      if (dscrGap > 0 && buy > 0.001) list.push(`Buy rate down ~ ${fmt(roundTo(buy*100,0.125))}% (points) to reach DSCR 1.25.`);

      const addDown = findExtraDownForTargetDSCR(ctx, T_DSCR);
      if (dscrGap > 0 && addDown > 0) list.push(`Increase down payment by ~ ${fmt(roundTo(addDown*100,1))}% of price to reach DSCR 1.25.`);

      if (cocGap > 0 && ctx.cashInvested > 0) {
        const targetCFannual = 0.08 * ctx.cashInvested;
        const deltaCFannual = Math.max(0, targetCFannual - (ctx.monthlyCashFlow*12));
        const deltaCFmo = deltaCFannual/12;
        const rentNeed = deltaCFmo / effRentFactor;
        if (rentNeed > 1) list.push(`For CoC 8%: raise rent ~ $${fmt(roundTo(rentNeed,25))}/mo (or trim expenses by ~$${fmt(roundTo(deltaCFmo,25))}/mo).`);
        else list.push(`For CoC 8%: trim expenses by ~$${fmt(roundTo(deltaCFmo,25))}/mo.`);
      }

      if (cfGap > 0) {
        const rentNeed = cfGap / effRentFactor;
        list.push(`Build $100/mo buffer: add ~$${fmt(roundTo(rentNeed,25))}/mo rent or cut ~$${fmt(roundTo(cfGap,25))}/mo expenses.`);
      }

      if (list.length===0) list.push("Numbers meet conservative thresholds. Consider a small rate buydown for safety and set aside 6‚Äì12 months of reserves.");

      document.getElementById("tweakList").innerHTML = list.map(li=>`<li>${li}</li>`).join("");
      document.getElementById("tweakBox").style.display = "block";
    }

    function cloneAndRecalc(ctx, overrides) {
      const price = overrides.price ?? ctx.price;
      const downPct = overrides.downPct ?? ctx.downPct;
      const rateAnnual = overrides.rateAnnual ?? ctx.rateAnnual;
      const rate = rateAnnual/12;
      const termYears = ctx.termYears;

      const loanAmount = Math.max(price - price*downPct, 0);
      const months = termYears * 12;
      const monthlyDebt = -pmt(rate, months, loanAmount);
      const annualDebt = monthlyDebt * 12;
      const noiAnnual = ctx.noiAnnual;

      const dscr = annualDebt > 0 ? (noiAnnual / annualDebt) : Infinity;
      return { dscr, monthlyDebt, annualDebt };
    }

    function findPriceCutForTargetDSCR(ctx, target) {
      let lo=0, hi=ctx.price*0.30, ans=0;
      for (let i=0;i<25;i++){
        const mid=(lo+hi)/2;
        const { dscr }=cloneAndRecalc(ctx,{price:ctx.price-mid,downPct:ctx.downPct});
        if (dscr>=target){ ans=mid; hi=mid-100; } else { lo=mid+100; }
      }
      return Math.max(0,ans);
    }

    function findRateBuydownForTargetDSCR(ctx, target) {
      let lo=0, hi=0.03, ans=0;
      for (let i=0;i<30;i++){
        const mid=(lo+hi)/2;
        const { dscr }=cloneAndRecalc(ctx,{rateAnnual:Math.max(0.001,ctx.rateAnnual-mid)});
        if (dscr>=target){ ans=mid; hi=mid-0.0005; } else { lo=mid+0.0005; }
      }
      return Math.max(0,ans);
    }

    function findExtraDownForTargetDSCR(ctx, target) {
      let lo=0, hi=0.20, ans=0;
      for (let i=0;i<25;i++){
        const mid=(lo+hi)/2;
        const newDown=Math.min(0.90,ctx.downPct+mid);
        const { dscr }=cloneAndRecalc(ctx,{downPct:newDown});
        if (dscr>=target){ ans=mid; hi=mid-0.005; } else { lo=mid+0.005; }
      }
      return Math.max(0,ans);
    }

    // ---------- Baseline & Scenario B ----------
    function snapshotBaseline(){
      const ctx = readInputs();
      if (!ctx.price || !ctx.rent) {
        alert("Enter Price and Rent first, then click Analyze (optional) and Save as Baseline.");
        return;
      }
      baseline = ctx;
      document.getElementById("baselineNote").innerHTML =
        `Baseline captured ‚Ä¢ Price $${fmt(ctx.price)}, Rent $${fmt(ctx.rent)}, Rate ${(ctx.rateAnnual*100).toFixed(2)}%`;

      document.getElementById("b_priceCut").value = Math.round(ctx.price*0.03);
      document.getElementById("b_rentUp").value = 100;
      document.getElementById("b_rateDown").value = 0.5;
      document.getElementById("b_downUpPct").value = 5;
      document.getElementById("b_expTrim").value = 50;
    }

    function buildScenarioBFromBaseline(){
      if (!baseline) return null;

      const tweaks = {
        priceCut: n(document.getElementById("b_priceCut").value),
        rentUp: n(document.getElementById("b_rentUp").value),
        rateDownPts: n(document.getElementById("b_rateDown").value),
        downUpPct: n(document.getElementById("b_downUpPct").value) / 100,
        expTrim: n(document.getElementById("b_expTrim").value)
      };

      const A = baseline;
      const Ares = calcKPIs(A);

      const B = { ...A };
      B.price = Math.max(0, A.price - tweaks.priceCut);
      B.rent  = Math.max(0, A.rent + tweaks.rentUp);
      B.rateAnnual = Math.max(0.001, A.rateAnnual - (tweaks.rateDownPts/100));
      B.downPct = Math.min(0.90, A.downPct + tweaks.downUpPct);

      const fixSum = (A.taxes + A.insurance + A.hoa + A.utilities) || 1;
      const t = tweaks.expTrim;
      B.taxes = Math.max(0, A.taxes - t*(A.taxes/fixSum));
      B.insurance = Math.max(0, A.insurance - t*(A.insurance/fixSum));
      B.hoa = Math.max(0, A.hoa - t*(A.hoa/fixSum));
      B.utilities = Math.max(0, A.utilities - t*(A.utilities/fixSum));

      const Bres = calcKPIs(B);
      return { baselineCtx:A, baselineKPIs:Ares, scenarioCtx:B, scenarioKPIs:Bres };
    }

    function recalcScenarioB(){
      if (!baseline) {
        alert("Click ‚ÄúSave as Baseline for Comparison‚Äù first.");
        return;
      }
      const pack = buildScenarioBFromBaseline();
      if (!pack) return;
      renderCompare(pack.baselineKPIs, pack.scenarioKPIs);
    }

    function renderCompare(A, B){
      const rows = [
        ["Cap Rate", `${fmt(A.capRate)}%`, `${fmt(B.capRate)}%`, (x,y)=>x<y],
        ["DSCR",     A.dscr===Infinity?"‚àû":fmt(A.dscr), B.dscr===Infinity?"‚àû":fmt(B.dscr), (x,y)=> (x==='‚àû'?Infinity:x) < (y==='‚àû'?Infinity:y)],
        ["CoC",      `${fmt(A.coc)}%`, `${fmt(B.coc)}%`, (x,y)=>parseFloat(x)<parseFloat(y)],
        ["CF / mo",  `$${fmt(A.monthlyCashFlow)}`, `$${fmt(B.monthlyCashFlow)}`, (x,y)=>parseFloat(x.replace(/[$,]/g,''))<parseFloat(y.replace(/[$,]/g,''))],
        ["Debt / mo",`$${fmt(A.monthlyDebt)}`, `$${fmt(B.monthlyDebt)}`, (x,y)=>parseFloat(x.replace(/[$,]/g,''))>parseFloat(y.replace(/[$,]/g,''))]
      ];
      const body = document.getElementById("cmpBody");
      body.innerHTML = rows.map(([label,a,b,isBetterB])=>{
        const winB = isBetterB(a,b) ? ' class="win right"' : ' class="right"';
        return `<tr><td>${label}</td><td class="right">${a}</td><td${winB}>${b}</td></tr>`;
      }).join("");
    }

    function applyScenarioB(){
      if (!baseline) {
        alert("Click ‚ÄúSave as Baseline for Comparison‚Äù first, then Preview B.");
        return;
      }
      const pack = buildScenarioBFromBaseline();
      if (!pack) return;
      writeInputs(pack.scenarioCtx);
      analyze();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function saveScenarioB() {
      if (!baseline) {
        alert("Capture a baseline first, then set Scenario B tweaks.");
        return;
      }

      const pack = buildScenarioBFromBaseline();
      if (!pack) {
        alert("Unable to build Scenario B. Check your inputs.");
        return;
      }

      const ctx = pack.scenarioCtx;
      const k = pack.scenarioKPIs;

      const { data:userData } = await sb.auth.getUser();
      const user_id = userData?.user?.id;
      if (!user_id) {
        alert("Not signed in");
        return;
      }

      const payload = {
        user_id,
        price: ctx.price,
        rent: ctx.rent,
        expenses: k.opexMo,
        down_payment_pct: ctx.downPct*100,
        interest_rate: ctx.rateAnnual*100,
        term_years: ctx.termYears,
        closing_cost_pct: ctx.closingPct*100,
        other_income: ctx.otherIncome,
        vacancy_pct: ctx.vacancyPct*100,
        taxes_monthly: ctx.taxes,
        insurance_monthly: ctx.insurance,
        hoa_monthly: ctx.hoa,
        utilities_monthly: ctx.utilities,
        mgmt_pct: ctx.mgmtPct*100,
        maint_pct: ctx.maintPct*100,
        capex_pct: ctx.capexPct*100,
        rehab_budget: ctx.rehabBudget,
        roi: 0,
        cap_rate: Number(k.capRate.toFixed(2)),
        cash_flow: Number(k.monthlyCashFlow.toFixed(2)),
        dscr: Number((k.dscr===Infinity? 9999 : k.dscr).toFixed(3)),
        coc: Number(k.coc.toFixed(2))
      };

      const { error } = await sb.from("deals").insert(payload);
      if (error) {
        console.error(error);
        alert("Save Scenario B failed: " + (error.message || "Unknown error"));
        return;
      }

      alert("Scenario B saved as a separate deal ‚úÖ");
      await loadRecentAnalyses();
    }

    // ---------- Save / Load ----------
    async function saveDeal() {
      if (!lastCalc) {
        alert("Analyze a deal first.");
        return;
      }
      const { data:userData } = await sb.auth.getUser();
      const user_id = userData?.user?.id;
      if (!user_id) {
        alert("Not signed in");
        return;
      }
      const payload = { user_id, ...lastCalc };
      const { error } = await sb.from("deals").insert(payload);
      if (error) {
        console.error(error);
        alert("Save failed: " + (error.message || "Unknown error"));
        return;
      }
      alert("Deal saved ‚úÖ");
      await loadRecentAnalyses();
    }

    async function loadRecentAnalyses() {
      const tbody = document.getElementById('deal-history-body');
      const loadingRow = document.getElementById('deal-history-loading');

      if (!tbody) {
        console.warn('[deal-analyzer] #deal-history-body not found; skipping history load.');
        return;
      }

      if (!window.supabaseClient) {
        console.warn('[deal-analyzer] supabaseClient not available; skipping history load.');
        if (loadingRow) {
          loadingRow.innerHTML = '<td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">No analyses yet. Run your first deal above!</td>';
        }
        return;
      }

      const supabaseClient = window.supabaseClient;

      // Get current user
      const { data: userData, error: userError } = await supabaseClient.auth.getUser();
      const user = userData?.user || null;

      if (userError) {
        console.error('[deal-analyzer] Error getting user:', userError);
        if (loadingRow) {
          loadingRow.innerHTML = '<td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">No analyses yet. Run your first deal above!</td>';
        }
        return;
      }

      // LOGGED OUT --> show premium-style message row, no redirect
      if (!user) {
        tbody.innerHTML = `
      <tr class="ra-loggedout-row">
        <td colspan="7">
          <div class="ra-loggedout-flex">

            <span class="ra-lock-icon">üîí</span>

            <div class="ra-textblock">
              <strong>Save your deals & track performance over time.</strong>
              <div class="ra-subtext">
                Log in to unlock your personal deal history, comparisons, and cash-flow tracking.
              </div>
            </div>

            <button class="ra-login-btn" type="button" onclick="window.location.href='/login.html'">
              Log In
            </button>

            <div class="ra-tooltip">
              ?
              <div class="ra-tooltip-content">
                When you're logged in, every analysis can be saved to your private history so you can compare scenarios, revisit numbers, and export everything later.
              </div>
            </div>

          </div>
        </td>
      </tr>
    `;
        return;
      }

      // LOGGED IN --> load recent deals from Supabase
      const { data: deals, error: dealsError } = await supabaseClient
        .from('deals')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false })
        .limit(10);

      if (dealsError) {
        console.error('[deal-analyzer] Error loading deals:', dealsError);
        tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">No analyses yet. Run your first deal above!</td>
      </tr>
    `;
        return;
      }

      // Clear loading row
      tbody.innerHTML = '';

      if (!deals || deals.length === 0) {
        tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; color: #64748b; padding: 2rem;">No analyses yet. Run your first deal above!</td>
      </tr>
    `;
        return;
      }

      deals.forEach((d) => {
        const tr = document.createElement('tr');

        const createdAt = d.created_at ? new Date(d.created_at).toLocaleDateString() : '';

        tr.innerHTML = `
      <td>${createdAt}</td>
      <td>${d.purchase_price ?? ''}</td>
      <td>${d.monthly_rent ?? ''}</td>
      <td>${d.dscr ?? ''}</td>
      <td>${d.coc ?? ''}</td>
      <td>${d.cap_rate ?? ''}</td>
      <td>${d.cash_flow_month ?? ''}</td>
    `;

        tbody.appendChild(tr);
      });

      console.log('[deal-analyzer] Loaded', deals.length, 'deals into history.');
    }

    async function delDeal(id) {
      if (!confirm("Delete this analysis?")) return;
      const { error } = await sb.from("deals").delete().eq("id", id);
      if (error) {
        console.error(error);
        alert("Delete failed: " + (error.message || "Unknown error"));
        return;
      }
      await loadRecentAnalyses();
    }
  </script>

  <script>
    // Free trial limit enforcement (3 runs per browser)
    (function () {
      const LIMIT = 3;
      const STORAGE_KEY = 'retotal_deal_runs';

      const analyzeBtn = document.getElementById('analyze-btn');
      const limitBanner = document.getElementById('deal-limit-banner');

      if (!analyzeBtn) return;

      function getRunCount() {
        const raw = localStorage.getItem(STORAGE_KEY);
        const n = parseInt(raw, 10);
        return Number.isNaN(n) ? 0 : n;
      }

      function setRunCount(n) {
        localStorage.setItem(STORAGE_KEY, String(n));
      }

      function showLimitBanner() {
        if (!limitBanner) return;
        limitBanner.style.display = 'block';
      }

      function checkLimit() {
        // Only enforce in production
        if (!IS_PRODUCTION) {
          return { allowed: true, remaining: Infinity };
        }

        const runs = getRunCount();
        const allowed = runs < LIMIT;
        const remaining = Math.max(0, LIMIT - runs);
        return { allowed, remaining };
      }

      // Initial state: if they already used up their runs, block the button
      const { allowed } = checkLimit();
      if (!allowed) {
        analyzeBtn.disabled = true;
        analyzeBtn.style.opacity = '0.6';
        analyzeBtn.style.cursor = 'not-allowed';
        showLimitBanner();
      }

      analyzeBtn.addEventListener('click', function (e) {
        const { allowed } = checkLimit();

        if (!allowed) {
          e.preventDefault();
          analyzeBtn.disabled = true;
          analyzeBtn.style.opacity = '0.6';
          analyzeBtn.style.cursor = 'not-allowed';
          showLimitBanner();
          return;
        }

        // Increment run count (production only)
        if (IS_PRODUCTION) {
          let runs = getRunCount();
          runs += 1;
          setRunCount(runs);

          // Show message when limit reached
          if (runs >= LIMIT) {
            showLimitBanner();
          }
        }
      });
    })();
  </script>
</body>
</html>
